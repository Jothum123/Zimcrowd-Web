<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com; img-src 'self' data: https:; connect-src 'self' https://zimcrowd-backend.vercel.app http://localhost:3000;">
    <title>Kairo AI Assistant - ZimCrowd</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="js/api-config-new.js"></script>
    <script src="js/api-helper.js"></script>
    <script src="js/api-client.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Space Grotesk', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .chat-container {
            width: 100%;
            max-width: 1200px;
            height: 90vh;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            display: flex;
            overflow: hidden;
        }

        /* Sidebar */
        .chat-sidebar {
            width: 300px;
            background: #f8fafc;
            border-right: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
        }

        .kairo-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .kairo-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            font-weight: 600;
        }

        .kairo-info h3 {
            color: #1a202c;
            font-size: 18px;
            margin-bottom: 4px;
        }

        .kairo-info p {
            color: #718096;
            font-size: 14px;
        }

        .ai-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #e6fffa;
            border-radius: 8px;
            font-size: 12px;
            color: #065f46;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Quick Actions */
        .quick-actions {
            padding: 20px;
            flex: 1;
        }

        .quick-actions h4 {
            color: #1a202c;
            margin-bottom: 15px;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .action-button {
            width: 100%;
            padding: 12px 16px;
            margin-bottom: 8px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            color: #4a5568;
        }

        .action-button:hover {
            background: #f7fafc;
            border-color: #667eea;
            color: #667eea;
        }

        .action-button i {
            margin-right: 8px;
            width: 16px;
        }

        /* Main Chat Area */
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            background: white;
        }

        .chat-header h2 {
            color: #1a202c;
            margin-bottom: 4px;
        }

        .chat-header p {
            color: #718096;
            font-size: 14px;
        }

        /* Messages Area */
        .messages-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8fafc;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            gap: 12px;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: #667eea;
            color: white;
        }

        .message.ai .message-avatar {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .message-content {
            max-width: 70%;
            padding: 16px 20px;
            border-radius: 18px;
            position: relative;
        }

        .message.user .message-content {
            background: #667eea;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.ai .message-content {
            background: white;
            color: #1a202c;
            border: 1px solid #e2e8f0;
            border-bottom-left-radius: 4px;
        }

        .message-time {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 8px;
        }

        .message-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .suggestion-chip {
            padding: 6px 12px;
            background: #e2e8f0;
            border-radius: 16px;
            font-size: 12px;
            color: #4a5568;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .suggestion-chip:hover {
            background: #667eea;
            color: white;
        }

        /* Typing Indicator */
        .typing-indicator {
            display: none;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
            padding: 16px 20px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 18px;
            border-bottom-left-radius: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: #cbd5e0;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        /* Input Area */
        .chat-input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #e2e8f0;
        }

        .chat-input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            min-height: 44px;
            max-height: 120px;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 22px;
            resize: none;
            font-family: inherit;
            font-size: 14px;
            line-height: 1.4;
            outline: none;
            transition: border-color 0.2s ease;
        }

        .chat-input:focus {
            border-color: #667eea;
        }

        .send-button {
            width: 44px;
            height: 44px;
            background: #667eea;
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .send-button:hover {
            background: #5a67d8;
            transform: scale(1.05);
        }

        .send-button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        /* Welcome Message */
        .welcome-message {
            text-align: center;
            padding: 40px 20px;
            color: #718096;
        }

        .welcome-message .kairo-avatar {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            font-size: 32px;
        }

        .welcome-message h3 {
            color: #1a202c;
            margin-bottom: 8px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .chat-container {
                height: 100vh;
                border-radius: 0;
            }

            .chat-sidebar {
                display: none;
            }

            .message-content {
                max-width: 85%;
            }
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- Sidebar -->
        <div class="chat-sidebar">
            <div class="sidebar-header">
                <div class="kairo-profile">
                    <div class="kairo-avatar">K</div>
                    <div class="kairo-info">
                        <h3>Kairo AI</h3>
                        <p>Financial Assistant</p>
                    </div>
                </div>
                <div class="ai-status">
                    <div class="status-dot"></div>
                    <span id="ai-status-text">OpenRouter AI Active</span>
                </div>
            </div>

            <div class="quick-actions">
                <h4>Quick Actions</h4>
                <button class="action-button" onclick="sendQuickMessage('What is my ZimScore?')">
                    <i class="fas fa-chart-line"></i>
                    Check My ZimScore
                </button>
                <button class="action-button" onclick="sendQuickMessage('I want to apply for a loan')">
                    <i class="fas fa-hand-holding-usd"></i>
                    Apply for Loan
                </button>
                <button class="action-button" onclick="sendQuickMessage('Show me investment options')">
                    <i class="fas fa-chart-pie"></i>
                    Investment Options
                </button>
                <button class="action-button" onclick="sendQuickMessage('Help me create a budget')">
                    <i class="fas fa-calculator"></i>
                    Budget Planning
                </button>
                <button class="action-button" onclick="sendQuickMessage('How can I improve my credit score?')">
                    <i class="fas fa-arrow-up"></i>
                    Improve Credit
                </button>
                <button class="action-button" onclick="sendQuickMessage('What are the current market trends?')">
                    <i class="fas fa-trending-up"></i>
                    Market Insights
                </button>
                <button class="action-button" onclick="clearChat()">
                    <i class="fas fa-trash"></i>
                    Clear Chat
                </button>
                <button class="action-button" onclick="window.location.href='dashboard.html'">
                    <i class="fas fa-arrow-left"></i>
                    Back to Dashboard
                </button>
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="chat-main">
            <div class="chat-header">
                <h2>Chat with Kairo AI</h2>
                <p>Your intelligent financial assistant powered by advanced AI</p>
            </div>

            <div class="messages-container" id="messages-container">
                <div class="welcome-message" id="welcome-message">
                    <div class="kairo-avatar">K</div>
                    <h3>Hello! I'm Kairo, your AI financial assistant</h3>
                    <p>I'm here to help you with loans, investments, budgeting, and financial planning.<br>
                    Ask me anything about your finances or use the quick actions on the left!</p>
                </div>
            </div>

            <!-- Typing Indicator -->
            <div class="typing-indicator" id="typing-indicator">
                <div class="message-avatar">
                    <div class="kairo-avatar">K</div>
                </div>
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>

            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <textarea 
                        id="chat-input" 
                        class="chat-input" 
                        placeholder="Ask me about loans, investments, or financial planning..."
                        rows="1"
                    ></textarea>
                    <button id="send-button" class="send-button" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let conversationHistory = [];
        let isTyping = false;

        // Initialize chat
        document.addEventListener('DOMContentLoaded', function() {
            checkAIStatus();
            setupInputHandlers();
        });

        // Check AI system status
        async function checkAIStatus() {
            try {
                const token = localStorage.getItem('token');
                const headers = token ? {
                    'Authorization': `Bearer ${token}`
                } : {};
                
                const response = await fetch(`${API_CONFIG.BASE_URL}/api/kairo-ai`, {
                    headers: headers
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const aiSystem = data.data.aiSystem;
                    const statusText = document.getElementById('ai-status-text');
                    
                    if (aiSystem && aiSystem.primaryAI && aiSystem.primaryAI.enabled) {
                        statusText.textContent = `${aiSystem.primaryAI.provider.toUpperCase()} AI Active`;
                    } else {
                        statusText.textContent = 'Kairo AI Active';
                    }
                } else {
                    // Fallback status for testing
                    document.getElementById('ai-status-text').textContent = 'OpenRouter AI Active';
                }
            } catch (error) {
                console.error('Failed to check AI status:', error);
                // Fallback status for testing
                document.getElementById('ai-status-text').textContent = 'OpenRouter AI Active';
            }
        }

        // Setup input handlers
        function setupInputHandlers() {
            const input = document.getElementById('chat-input');
            const sendButton = document.getElementById('send-button');

            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            input.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                
                sendButton.disabled = this.value.trim() === '' || isTyping;
            });
        }

        // Send message
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message || isTyping) return;

            // Clear welcome message
            const welcomeMessage = document.getElementById('welcome-message');
            if (welcomeMessage) {
                welcomeMessage.style.display = 'none';
            }

            // Add user message
            addMessage(message, 'user');
            input.value = '';
            input.style.height = 'auto';
            
            // Show typing indicator
            showTypingIndicator();
            
            try {
                const token = localStorage.getItem('token');
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                
                const response = await fetch(`${API_CONFIG.BASE_URL}/api/kairo-ai/chat`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        message: message,
                        context: {
                            recentMessages: conversationHistory.slice(-4)
                        }
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    // Add AI response
                    addMessage(data.data.response, 'ai', data.data.suggestions, {
                        aiProvider: data.data.aiProvider,
                        fallbackUsed: data.data.fallbackUsed
                    });
                    
                    // Update conversation history
                    conversationHistory.push(
                        { sender: 'user', content: message, timestamp: new Date() },
                        { sender: 'ai', content: data.data.response, timestamp: new Date() }
                    );
                } else {
                    // Fallback response for testing
                    const fallbackResponse = generateFallbackResponse(message);
                    addMessage(fallbackResponse, 'ai', ['Tell me more', 'How can I help?'], {
                        aiProvider: 'fallback',
                        fallbackUsed: true
                    });
                }
            } catch (error) {
                console.error('Chat error:', error);
                // Fallback response for testing
                const fallbackResponse = generateFallbackResponse(message);
                addMessage(fallbackResponse, 'ai', ['Try again', 'Ask another question'], {
                    aiProvider: 'fallback',
                    fallbackUsed: true
                });
            } finally {
                hideTypingIndicator();
            }
        }

        // Send quick message
        function sendQuickMessage(message) {
            document.getElementById('chat-input').value = message;
            sendMessage();
        }

        // Add message to chat
        function addMessage(content, sender, suggestions = [], metadata = {}) {
            const messagesContainer = document.getElementById('messages-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.innerHTML = sender === 'user' ? 
                (localStorage.getItem('user_name')?.charAt(0).toUpperCase() || 'U') : 
                '<div class="kairo-avatar">K</div>';
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            let contentHTML = `<div>${content}</div>`;
            
            // Add AI provider info for AI messages
            if (sender === 'ai' && metadata.aiProvider) {
                const providerInfo = metadata.fallbackUsed ? 
                    `<small style="opacity: 0.7;">Powered by ${metadata.aiProvider} (fallback)</small>` :
                    `<small style="opacity: 0.7;">Powered by ${metadata.aiProvider}</small>`;
                contentHTML += providerInfo;
            }
            
            contentHTML += `<div class="message-time">${new Date().toLocaleTimeString()}</div>`;
            
            // Add suggestions
            if (suggestions && suggestions.length > 0) {
                contentHTML += '<div class="message-suggestions">';
                suggestions.forEach(suggestion => {
                    contentHTML += `<span class="suggestion-chip" onclick="sendQuickMessage('${suggestion}')">${suggestion}</span>`;
                });
                contentHTML += '</div>';
            }
            
            messageContent.innerHTML = contentHTML;
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            messagesContainer.appendChild(messageDiv);
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Show typing indicator
        function showTypingIndicator() {
            isTyping = true;
            document.getElementById('typing-indicator').style.display = 'flex';
            document.getElementById('send-button').disabled = true;
            
            const messagesContainer = document.getElementById('messages-container');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Hide typing indicator
        function hideTypingIndicator() {
            isTyping = false;
            document.getElementById('typing-indicator').style.display = 'none';
            document.getElementById('send-button').disabled = false;
        }

        // Generate fallback response for testing
        function generateFallbackResponse(message) {
            const lowerMessage = message.toLowerCase();
            
            if (lowerMessage.includes('loan')) {
                return "I'd be happy to help you with loan information! ZimCrowd offers competitive rates starting from 12% APR based on your ZimScore. Would you like to know more about our loan products or check your eligibility?";
            } else if (lowerMessage.includes('investment')) {
                return "Great question about investments! ZimCrowd offers 5 investment products including Money Market, Treasury Bills, and Equity Funds with returns up to 18% annually. What's your risk tolerance and investment timeline?";
            } else if (lowerMessage.includes('zimscore')) {
                return "Your ZimScore is your financial health indicator ranging from 300-850. It affects your loan rates and investment options. To check your current ZimScore, please log in to your dashboard. Would you like tips on improving it?";
            } else if (lowerMessage.includes('budget')) {
                return "I can help you create a personalized budget! The 50/30/20 rule is a great starting point: 50% needs, 30% wants, 20% savings. What's your monthly income and main expenses?";
            } else if (lowerMessage.includes('hi') || lowerMessage.includes('hello')) {
                return "Hello! I'm Kairo, your AI financial assistant. I'm here to help with loans, investments, budgeting, and financial planning. What would you like to know about today?";
            } else {
                return "Thank you for your question! I'm here to help with all your financial needs including loans, investments, budgeting, and ZimScore improvement. Could you tell me more about what specific financial topic you'd like assistance with?";
            }
        }

        // Clear chat
        function clearChat() {
            const messagesContainer = document.getElementById('messages-container');
            messagesContainer.innerHTML = `
                <div class="welcome-message" id="welcome-message">
                    <div class="kairo-avatar">K</div>
                    <h3>Hello! I'm Kairo, your AI financial assistant</h3>
                    <p>I'm here to help you with loans, investments, budgeting, and financial planning.<br>
                    Ask me anything about your finances or use the quick actions on the left!</p>
                </div>
            `;
            conversationHistory = [];
        }

        // Check authentication - temporarily disabled for testing
        if (!localStorage.getItem('token')) {
            console.log('No token found, but allowing access for testing');
            // Temporarily disable redirect for testing
            // window.location.href = 'login.html';
        }
    </script>
</body>
</html>
